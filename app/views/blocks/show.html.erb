<% case @block.estado %>
<% when 0 #bloque normal %>

	<% if logged_in_admin? %>

		<% if((@block.fecha << 6) <=> Date.today) <= 0 %>

			<!-- Boton crear subasta -->

			<%= form_for(@block) do |b| %>
				<div class="input-group">
					<%= b.text_field :precio, class: 'form-control rounded-0 col-6' %>
					<%= b.hidden_field :estado, :value => 1 %>
					<div class="input-group-append p-0 m-0 col-6">
						<%= b.submit "Crear subasta", class: 'btn btn-primary rounded-0' %>
					</div>
				</div>
			<% end %>

			<!-- Boton crear hotsale -->

			<%= form_for(@block) do |b| %>
				<div class="input-group">
					<%= b.text_field :precio, class: 'form-control rounded-0 col-6' %>
					<%= b.hidden_field :estado, :value => 2 %>
					<div class="input-group-append p-0 m-0 col-6">
						<%= b.submit "Crear hotsale", class: 'btn btn-secondary rounded-0' %>
					</div>
				</div>
			<% end %>

		<% else %>

			<div class="alert alert-warning" role="alert">
				La subasta estara disponible a partir del dia <%= @block.fecha << 6 %>
			</div>

		<%end%>

		<h5 class="mt-3">Participantes</h3>
		<div class="list-group" style="height:200px; overflow-y:scroll;">
			<% @block.entries.each do |entry|%>
				<div class="list-group-item">
					<small><%= entry.email %></small>
				</div>
			<%end%>
		</div>

    <% else %>

		<% if (@block.adjudicado == '' || @block.adjudicado == nil) %>

			<%= form_for(Entry.new) do |e| %>
				<div class="input-group">
					<%= e.hidden_field :block_id, :value => @block.id %>
					<%= e.hidden_field :user_id, :value => current_user.id %>
					<div class="input-group-append p-0 m-0 col-6">
						<%= e.submit "Participar", class: 'btn btn-secondary rounded-0' %>
					</div>
				</div>
			<% end %>

		<% end %>

	<% end %>

	<% if !(@block.adjudicado == '' || @block.adjudicado == nil) %>
		<% if logged_in_admin? %>
			<h5>Bloque adjudicado a <%= @block.adjudicado %></h5>
		<% else %>
			<h5>Bloque adjudicado!</h5>
		<% end %>
	<% end %>

<% when 1 #bloque en subasta %>

	<!-- Subasta -->

	<% if logged_in_admin? %>
		<%= form_for(@block) do |b| %>
			<div class="input-group">
				<%= b.hidden_field :estado, :value => 0 %>
				<% if @block.bids.order(valor: :desc).first != nil %>
				<%= b.hidden_field :adjudicado, :value => @block.bids.order(valor: :desc).first.entry.email %>
				<%end%>
				<div class="input-group-append p-0 m-0 col-6">
					<%= b.submit "Cerrar Subasta", class: 'btn btn-primary rounded-0' %>
				</div>
			</div>
		<% end %>

		<h5 class="mt-3">Participantes</h3>
		<div class="list-group" style="height:200px; overflow-y:scroll;">
			<% @block.entries.each do |entry|%>
				<div class="list-group-item">
					<small><%= entry.email %></small>
				</div>
			<%end%>
		</div>

	<% else %>

		<%= form_for(Bid.new) do |formulario| %>
				<div class="p-0 m-0 col-4">
					<%= formulario.submit "Salir de la Subasta", class: 'btn btn-danger rounded-0' %>
						<%= formulario.hidden_field :block_id, :value => @block.id %>
				<br></br>
				</div>
				<div class="input-group">
  				<%= text_field_tag :email, nil, class: 'form-control rounded-0 col-5 m-0', type: 'email', placeholder: 'participante@mail.com', required: true %>
				<%= formulario.text_field :valor, class: 'form-control rounded-0 col-5 m-0', placeholder: 'monto', oninput:'check(this)' %>
  				<%= formulario.hidden_field :block_id, :value => @block.id %>
  				<div class="input-group-append p-0 m-0 col-2">
  					<%= formulario.submit "Pujar!", class: 'btn btn-success rounded-0' %>
  				</div>
  			</div>
  		<% end %>

		<script>
			function check(input) {
			<% if @block.bids.order(valor: :desc).first != nil %>
			if ((input.value <= <%= @block.precio%>) || (input.value <= <%= @block.bids.order(valor: :desc).first.valor %> )) {
			<% else %>
			if ((input.value <= <%= @block.precio%>)) {
			<% end %>
				input.setCustomValidity('La puja debe ser mayor a la ultima realizada, o al piso.');
			} else {
				// input is fine -- reset the error message
				input.setCustomValidity('');
			}
			}
		</script>

	<% end %>

	<h5 class="mt-3">Pujas (piso <span class="badge badge-success"><%= @block.precio %></span>)</h3>
	<div class="list-group" style="height:200px; overflow-y:scroll;">
		<% @block.bids.order(valor: :desc).each do |bid|%>
			<div class="list-group-item">
				<small><%= bid.entry.email %> <span class="badge badge-success"><%= bid.valor %></span></small>
			</div>
		<%end%>
	</div>

<% when 2 #bloque en hotsale %>

	<!-- Hotsale -->

	<% if @block.adjudicado == '' || @block.adjudicado == nil %>

		<h5>Precio del bloque <span class="badge badge-success"><%= @block.precio %></span></h5>

		<% if logged_in_admin? %>

			<%= form_for(@block) do |b| %>
				<div class="input-group">
					<%= b.hidden_field :estado, :value => 0 %>
					<div class="input-group-append p-0 m-0 col-12">
						<%= b.submit "Cerrar Hotsale", class: 'btn btn-primary rounded-0' %>
					</div>
				</div>
			<% end %>

		<% else %>

			<%= form_for(@block) do |formulario| %>
				<div class="input-group">
					<%= formulario.text_field :adjudicado, class: 'form-control rounded-0 col-6' %>
					<div class="input-group-append p-0 m-0 col-6">
						<%= formulario.submit "Adjudicarme este bloque!", class: 'btn btn-primary rounded-0' %>
					</div>
				</div>
			<% end %>

		<% end %>

	<% else %>

		<% if !(@block.adjudicado == '' || @block.adjudicado == nil) %>
			<% if logged_in_admin? %>
				<h5>Bloque adjudicado a <%= @block.adjudicado %></h5>
			<% else %>
				<h5>Bloque adjudicado!</h5>
			<% end %>
		<% end %>

	<% end %>

<% end %>

<% parent_layout "residencia" %>
